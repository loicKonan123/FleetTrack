services:
  # API FleetTrack (Backend ASP.NET Core)
  api:
    build:
      context: ./FleetTrack
      dockerfile: src/FleetTrack.API/Dockerfile
    container_name: fleettrack-api
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/FleetTrack.db
      - Jwt__Secret=${JWT_SECRET:-VotreCleSecrete_MinimumLength32Characters!}
      - Jwt__Issuer=FleetTrackAPI
      - Jwt__Audience=FleetTrackClients
      - Captcha__Enabled=${CAPTCHA_ENABLED:-false}
      - Captcha__SiteKey=${CAPTCHA_SITE_KEY:-6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI}
      - Captcha__SecretKey=${CAPTCHA_SECRET_KEY:-6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe}
      - Frontend__Url=http://localhost:3000
    volumes:
      - fleettrack-data:/app/data
    networks:
      - fleettrack-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Frontend FleetTrack (Next.js)
  frontend:
    build:
      context: ./fleettrack-frontend
      dockerfile: Dockerfile
    container_name: fleettrack-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://api:8080/api
      - NEXT_PUBLIC_SIGNALR_HUB_URL=http://api:8080/hubs/gps
      - NEXT_PUBLIC_RECAPTCHA_SITE_KEY=${CAPTCHA_SITE_KEY:-6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - fleettrack-network
    restart: unless-stopped

# Volumes pour persister les donnees
volumes:
  fleettrack-data:
    driver: local

# Reseau pour la communication entre services
networks:
  fleettrack-network:
    driver: bridge
